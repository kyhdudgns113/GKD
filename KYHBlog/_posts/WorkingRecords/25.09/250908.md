## **채팅방 생성시 발생하는 문제들**

### **1. 채팅방 생성시 채팅방 목록 갱신 문제**

#### **상황**

- 길동이와 채팅방을 처음 만들었을때 채팅방 목록에 어떻게 추가하냐?

#### **문제**

- http 응답으로 갱신된 채팅방 목록을 받아오면 전송 데이터가 커질 수 있다.

#### **해결**

- 서버가 소켓 메시지로 나에게 새로운 채팅방이 생겼다고 메시지를 보내준다.

- 이 메시지를 수신하면 채팅방 배열을 갱신한다.

### **2. 채팅방 생성시 수신자의 채팅방 목록 갱신 문제**

#### **상황**

- 내가 길동이와 채팅방을 새로 만들었다.

- 그런데 채팅을 아직 치진 않았다.

#### **문제**

- 길동이의 채팅방 목록에는 채팅을 치기 전에는 새로 생긴 채팅방이 없어야 한다.

- 채팅을 치고나서 채팅방 목록이 업데이트 되어야 한다.

#### **해결**

- (정보) 채팅방 라우터

    + 유저 A 가 유저 B 와 채팅하려면 어느 채팅방을 써야 하는지 정보

        * 채팅방의 Primary Key, 안 읽은 메시지등의 정보가 있다.

    + 채팅방을 생성하면 라우터 데이터가 2개 생성된다.

        * 유저 A -> 유저 B 라우터 데이터

        * 유저 B -> 유저 A 라우터 데이터

- 채팅방 라우터 DB 에 활성화 상태 Column 을 추가한다.

    + 초기 채팅방을 만들때 나의 활성화 상태는 True, 상대방은 False 로 생성한다.

    + 채팅방 목록을 불러올때 이 데이터가 True 인것만 불러온다.

    + 불러온 채팅방들만 채팅방 목록에 띄운다.

    + 이러면 내가 길동이랑 채팅방을 만들어도 당장은 길동이의 목록에 뜨진 않게된다.

- 내가 길동이한테 메시지를 보내면?

    + 채팅 데이터가 소켓통신으로 서버에 전송된다.

    + 서버는 DB 에 채팅을 저장하고 채팅방 라우터 DB 의 활성화 상태를 True 로 바꿔준다.

    + 서버는 온라인 상태인 채팅방 유저 소켓들에 채팅 메시지를 뿌려준다.

        * 유저의 연결 상태에 따라서 안 읽은 메시지 개수를 늘려준다.

- 수신자의 입장에서

    + 채팅 데이터에 담겨있는 채팅방의 ID 가 채팅방 목록에 있는지 확인한다.

    + 만약 채팅방이 목록에 있고, 열려있을때

        * 열려있는 채팅방 채팅목록에 채팅을 추가한다.

    + 채팅방이 목록에 있고, 닫혀있을때

        * 안 읽은 메시지 개수를 갱신한다.

    + 채팅방이 목록에 없을때

        * 채팅방 정보를 서버에 GET 요청을 하고 목록을 갱신한다.

